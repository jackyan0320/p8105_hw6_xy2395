P8105\_hw6\_xy2395
================
Jack Yan
11/16/2018

Problem 1
---------

### Data manipulation

``` r
homicide_df = 
  read_csv("./data/homicide-data.csv") %>% 
  # Create a city_state variable
  mutate(city_state = str_c(city, ", ", state),
         # Create a binary variable indicating whether the homicide is solved
         resolved = as.numeric(disposition == "Closed by arrest")) %>% 
  # Omit some cities
  filter(!city_state %in% c('Dallas, TX', 'Phoenix, AZ', 'Kansas City, MO', 'Tulsa, AL')) %>% 
  # Modifiy victim_race to have categories white and non-white, with white as the reference category. 
  mutate(victim_race = if_else(victim_race == "White", "white", "non-white"),
         victim_race = fct_relevel(victim_race, "white")) %>%
  # Be sure that victim_age is numeric
  mutate(victim_age = as.numeric(victim_age))
```

    ## Parsed with column specification:
    ## cols(
    ##   uid = col_character(),
    ##   reported_date = col_integer(),
    ##   victim_last = col_character(),
    ##   victim_first = col_character(),
    ##   victim_race = col_character(),
    ##   victim_age = col_character(),
    ##   victim_sex = col_character(),
    ##   city = col_character(),
    ##   state = col_character(),
    ##   lat = col_double(),
    ##   lon = col_double(),
    ##   disposition = col_character()
    ## )

    ## Warning in evalq(as.numeric(victim_age), <environment>): NAs introduced by
    ## coercion

### Baltimore, MD

``` r
# fit a logistic regression
fit_logistic = 
  homicide_df %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

# obtain the estimate of OR
estimate =
  fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  # the estimate givrn by the model is log odds ratio
  select(term, log_OR = estimate, OR, p.value) %>% 
  filter(str_detect(term, "non-white") == TRUE)

# obtain the CI of OR

ci =
  suppressWarnings(
    confint(fit_logistic) %>% broom::tidy() %>% 
    mutate('95%_CI_lower_bound' = exp(X2.5..),
           '95%_CI_upper_bound' = exp(X97.5..)) %>% 
    filter(str_detect(.rownames, "non-white") == TRUE)
  )
```

    ## Waiting for profiling to be done...

``` r
# conbine columns 
bind_cols(estimate, ci) %>% 
  mutate(city = "Baltimore, MD") %>% 
  select(city, OR, `95%_CI_lower_bound`, `95%_CI_upper_bound`)
```

    ## # A tibble: 1 x 4
    ##   city             OR `95%_CI_lower_bound` `95%_CI_upper_bound`
    ##   <chr>         <dbl>                <dbl>                <dbl>
    ## 1 Baltimore, MD 0.441                0.312                0.620

Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims. Do this within a “tidy” pipeline, making use of purrr::map, list columns, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.

``` r
# build a function
run_glm = function(city_name){
  # fit a logistic regression
  fit_logistic = 
    homicide_df %>% 
    filter(city_state == city_name) %>% 
    glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())
  
  # obtain the estimate of OR
  estimate =
    fit_logistic %>% 
    broom::tidy() %>% 
    mutate(OR = exp(estimate)) %>%
    # the estimate givrn by the model is log odds ratio
    select(term, log_OR = estimate, OR, p.value) %>% 
    filter(str_detect(term, "non-white") == TRUE)
  
  # obtain the CI of OR
  
  ci =
  suppressWarnings(
    confint(profile(fit_logistic)) %>% broom::tidy() %>% 
    mutate('95%_CI_lower_bound' = exp(X2.5..),
           '95%_CI_upper_bound' = exp(X97.5..)
    ) %>% 
    filter(str_detect(.rownames, "non-white") == TRUE)
  )
  # conbine columns 
  bind_cols(estimate, ci) %>% 
    mutate(city_state = city_name) %>% 
    select(city_state, OR, `95%_CI_lower_bound`, `95%_CI_upper_bound`)
}
```

``` r
result_df = 
  homicide_df %>% 
  distinct(city_state) %>% 
  .$city_state %>% 
  map_df(., run_glm) 
```

Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.

``` r
result_df %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, 
             y = OR, 
             ymin = `95%_CI_lower_bound`, 
             ymax = `95%_CI_upper_bound`)
  ) +
    geom_point() +
    geom_errorbar() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, size = rel(0.8))) +
    labs(
      x = "City",
      y = "OR",
      title = "Odds ratio and CI for solving homicides comparing non-white victims to white victims"
    )
```

![](p8105_hw6_xy2395_files/figure-markdown_github/unnamed-chunk-5-1.png)

Comment:

Problem 2
---------
