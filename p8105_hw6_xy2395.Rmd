---
title: "P8105_hw6_xy2395"
author: "Jack Yan"
date: "11/16/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(modelr)
library(mgcv)
```


## Problem 1

### Data manipulation
 
```{r}
homicide_df = 
  read_csv("./data/homicide-data.csv") %>% 
  # Create a city_state variable
  mutate(city_state = str_c(city, ", ", state),
         # Create a binary variable indicating whether the homicide is solved
         resolved = as.numeric(disposition == "Closed by arrest")) %>% 
  # Omit some cities
  filter(!city_state %in% c('Dallas, TX', 'Phoenix, AZ', 'Kansas City, MO', 'Tulsa, AL')) %>% 
  # Modifiy victim_race to have categories white and non-white, with white as the reference category. 
  filter(victim_race != "Unknown") %>% 
  mutate(victim_race = if_else(victim_race == "White", "white", "non-white"),
         victim_race = fct_relevel(victim_race, "white")) %>%
  # Be sure that victim_age is numeric
  mutate(victim_age = as.numeric(victim_age))
  
```

### Baltimore, MD


```{r}
# fit a logistic regression
fit_logistic = 
  homicide_df %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

# obtain the estimate of OR
estimate =
  fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  # the estimate givrn by the model is log odds ratio
  select(term, log_OR = estimate, OR, p.value) %>% 
  filter(str_detect(term, "non-white") == TRUE)

# obtain the CI of OR

ci =
  suppressWarnings(
    confint(fit_logistic) %>% broom::tidy() %>% 
    mutate('95%_CI_lower_bound' = exp(X2.5..),
           '95%_CI_upper_bound' = exp(X97.5..)) %>% 
    filter(str_detect(.rownames, "non-white") == TRUE)
  )
# conbine columns 
bind_cols(estimate, ci) %>% 
  mutate(city = "Baltimore, MD") %>% 
  select(city, OR, `95%_CI_lower_bound`, `95%_CI_upper_bound`)
```

Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims. Do this within a “tidy” pipeline, making use of purrr::map, list columns, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.

```{r}
# build a function
run_glm = function(city_name){
  # fit a logistic regression
  fit_logistic = 
    homicide_df %>% 
    filter(city_state == city_name) %>% 
    glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())
  
  # obtain the estimate of OR
  estimate =
    fit_logistic %>% 
    broom::tidy() %>% 
    mutate(OR = exp(estimate)) %>%
    # the estimate givrn by the model is log odds ratio
    select(term, log_OR = estimate, OR, p.value) %>% 
    filter(str_detect(term, "non-white") == TRUE)
  
  # obtain the CI of OR
  
  ci =
  suppressWarnings(
    confint(profile(fit_logistic)) %>% broom::tidy() %>% 
    mutate('95%_CI_lower_bound' = exp(X2.5..),
           '95%_CI_upper_bound' = exp(X97.5..)
    ) %>% 
    filter(str_detect(.rownames, "non-white") == TRUE)
  )
  # conbine columns 
  bind_cols(estimate, ci) %>% 
    mutate(city_state = city_name) %>% 
    select(city_state, OR, `95%_CI_lower_bound`, `95%_CI_upper_bound`)
}
```

```{r, message=FALSE}
result_df = 
  homicide_df %>% 
  distinct(city_state) %>% 
  .$city_state %>% 
  map_df(., run_glm) 
```

Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.

```{r}
result_df %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, 
             y = OR, 
             ymin = `95%_CI_lower_bound`, 
             ymax = `95%_CI_upper_bound`)
  ) +
    geom_point() +
    geom_errorbar() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, size = rel(0.8))) +
    labs(
      x = "City",
      y = "OR",
      title = "Odds ratio and CI for solving homicides comparing non-white victims to white victims"
    )
  
```

Comment:


## Problem 2

### Data manipulation

```{r}
weight_df = 
  read_csv("./data/birthweight.csv") %>% 
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    malform = as.factor(malform),
    mrace = as.factor(mrace)
  )

str(weight_df)
```

### Fit a model

`Describe your modeling process` 

```{r }
fit_all = lm(bwt ~ ., data = weight_df)
summary(fit_all)

fit_mine = lm(bwt ~ babysex + bhead + blength + delwt + gaweeks + mrace + smoken, data = weight_df)
summary(fit_mine)

fit_mine_1 = lm(bwt ~ babysex + bhead + blength + delwt + gaweeks + mrace + smoken + bhead*babysex + blength*babysex + bhead*blength*babysex, data = weight_df)
summary(fit_mine_1)

read_csv("./data/birthweight.csv") %>%  
  cor()
```

### Ploting

and show a plot of model residuals against fitted values – use add_predictions and add_residuals in making this plot.

```{r}

weight_df %>% 
  add_predictions(fit_mine) %>%
  add_residuals(fit_mine) %>%
  ggplot(aes(y = resid, x = pred)) + 
  geom_point() 

```

### Compare your model to two others

```{r}
fit_alt_1 = lm(bwt ~ blength + gaweeks, data = weight_df)
fit_alt_2 = lm(bwt ~ bhead*blength*babysex, data = weight_df)

summary(fit_alt_1)
summary(fit_alt_2)
```

```{r}
cv_df = 
  crossv_mc(weight_df, n = 100) %>% 
  mutate(train = map(train, as_tibble),
         test  = map(test, as_tibble))

cv_df = 
  cv_df %>% 
  mutate(mine  = map(train, ~lm(bwt ~ babysex + bhead + blength + delwt + gaweeks + mrace + smoken, data = .x)),
         alt_1 = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
         alt_2 = map(train, ~lm(bwt ~ bhead*blength*babysex, data = .x))
  ) %>% 
  mutate(rmse_mine  = map2_dbl(mine,  test, ~rmse(model = .x, data = .y)),
         rmse_alt_1 = map2_dbl(alt_1, test, ~rmse(model = .x, data = .y)),
         rmse_alt_2 = map2_dbl(alt_2, test, ~rmse(model = .x, data = .y))
  )
           
```

```{r}
cv_df %>% 
  select(starts_with('rmse')) %>% 
  gather(key = model, value = rmse, rmse_mine:rmse_alt_2) %>% 
  group_by(model) %>% 
  ggplot(aes(x = model, y = rmse)) +
    geom_violin()
```

